// Copyright (c) 2023 The Stdlib Authors. License is Apache-2.0: http://www.apache.org/licenses/LICENSE-2.0
/// <reference types="./index.d.ts" />
import{isPrimitive as t}from"https://cdn.jsdelivr.net/gh/stdlib-js/assert-is-positive-integer@v0.1.0-esm/index.mjs";import e from"https://cdn.jsdelivr.net/gh/stdlib-js/assert-is-vector-like@v0.1.0-esm/index.mjs";import s from"https://cdn.jsdelivr.net/gh/stdlib-js/assert-is-ndarray-like@v0.1.0-esm/index.mjs";import i from"https://cdn.jsdelivr.net/gh/stdlib-js/utils-define-nonenumerable-read-only-property@esm/index.mjs";import r from"https://cdn.jsdelivr.net/gh/stdlib-js/error-tools-fmtprodmsg@v0.1.0-esm/index.mjs";import n from"https://cdn.jsdelivr.net/gh/stdlib-js/utils-define-nonenumerable-read-only-accessor@esm/index.mjs";import{ndarray as a}from"https://cdn.jsdelivr.net/gh/stdlib-js/blas-base-gdot@v0.1.0-esm/index.mjs";import{ndarray as o}from"https://cdn.jsdelivr.net/gh/stdlib-js/blas-base-gaxpy@v0.1.0-esm/index.mjs";import d from"https://cdn.jsdelivr.net/gh/stdlib-js/blas-base-dcopy@v0.1.0-esm/index.mjs";import h from"https://cdn.jsdelivr.net/gh/stdlib-js/blas-base-dscal@v0.1.0-esm/index.mjs";import l from"https://cdn.jsdelivr.net/gh/stdlib-js/math-base-special-max@v0.1.0-esm/index.mjs";import p from"https://cdn.jsdelivr.net/gh/stdlib-js/math-base-special-exp@v0.1.0-esm/index.mjs";import m from"https://cdn.jsdelivr.net/gh/stdlib-js/math-base-special-pow@v0.1.0-esm/index.mjs";import c from"https://cdn.jsdelivr.net/gh/stdlib-js/math-base-special-expit@v0.1.0-esm/index.mjs";import g from"https://cdn.jsdelivr.net/gh/stdlib-js/array-float64@v0.1.0-esm/index.mjs";import f from"https://cdn.jsdelivr.net/gh/stdlib-js/ndarray-ctor@esm/index.mjs";import j from"https://cdn.jsdelivr.net/gh/stdlib-js/ndarray-base-shape2strides@v0.1.0-esm/index.mjs";import v from"https://cdn.jsdelivr.net/gh/stdlib-js/ndarray-base-numel@v0.1.0-esm/index.mjs";import u from"https://cdn.jsdelivr.net/gh/stdlib-js/ndarray-base-vind2bind@v0.1.0-esm/index.mjs";import{isPrimitive as _}from"https://cdn.jsdelivr.net/gh/stdlib-js/assert-is-nonnegative-number@v0.1.0-esm/index.mjs";import{isPrimitive as b}from"https://cdn.jsdelivr.net/gh/stdlib-js/assert-is-positive-number@v0.1.0-esm/index.mjs";import{isPrimitive as y}from"https://cdn.jsdelivr.net/gh/stdlib-js/assert-is-number@v0.1.0-esm/index.mjs";import{isPrimitive as w}from"https://cdn.jsdelivr.net/gh/stdlib-js/assert-is-boolean@v0.1.0-esm/index.mjs";import R from"https://cdn.jsdelivr.net/gh/stdlib-js/assert-is-array-like-object@v0.1.0-esm/index.mjs";import x from"https://cdn.jsdelivr.net/gh/stdlib-js/assert-is-plain-object@v0.1.0-esm/index.mjs";import E from"https://cdn.jsdelivr.net/gh/stdlib-js/assert-has-own-property@v0.1.0-esm/index.mjs";import L from"https://cdn.jsdelivr.net/gh/stdlib-js/assert-contains@esm/index.mjs";var P={basic:"_basicLearningRate",constant:"_constantLearningRate",invscaling:"_inverseScalingLearningRate",pegasos:"_pegasosLearningRate"},T={hinge:"_hingeLoss",log:"_logLoss",modifiedHuber:"_modifiedHuberLoss",perceptron:"_perceptronLoss",squaredHinge:"_squaredHingeLoss"};function H(t,e){var s;return this._N=t,this._opts=e,this._scaleFactor=1,this._t=0,this._learningRateMethod=P[e.learningRate[0]],this._lossMethod=T[e.loss],s=t,e.intercept&&(s+=1),this._weights=new g(s),this._coefficients=new f("float64",new g(s),[s],[1],0,"row-major"),this}i(H.prototype,"_add",(function(t,e){var s=e/this._scaleFactor,i=this._weights;return o(t.shape[0],s,t.data,t.strides[0],t.offset,i,1,0),this._opts.intercept&&(i[this._N]+=s),this})),i(H.prototype,"_basicLearningRate",(function(){return 10/(10+this._t)})),i(H.prototype,"_constantLearningRate",(function(){return this._opts.learningRate[1]})),i(H.prototype,"_dot",(function(t,e,s){var i=a(this._N,this._weights,1,0,t,e,s);return this._opts.intercept&&(i+=this._weights[this._N]),i*=this._scaleFactor})),i(H.prototype,"_hingeLoss",(function(t,e){var s;return s=this[this._learningRateMethod](),this._regularize(s),e*this._dot(t.data,t.strides[0],t.offset)<1&&this._add(t,e*s),this})),i(H.prototype,"_inverseScalingLearningRate",(function(){var t=this._opts.learningRate;return t[1]/m(this._t,t[2])})),i(H.prototype,"_logLoss",(function(t,e){var s,i,r;return i=this[this._learningRateMethod](),this._regularize(i),r=this._dot(t.data,t.strides[0],t.offset),s=e/(1+p(e*r)),this._add(t,i*s),this})),i(H.prototype,"_modifiedHuberLoss",(function(t,e){var s,i;return s=this[this._learningRateMethod](),this._regularize(s),(i=e*this._dot(t.data,t.strides[0],t.offset))<-1?this._add(t,4*s*e):this._add(t,s*(e-i*e)),this})),i(H.prototype,"_pegasosLearningRate",(function(){return 1/(this._opts.lambda*this._t)})),i(H.prototype,"_perceptronLoss",(function(t,e){var s;return s=this[this._learningRateMethod](),this._regularize(s),e*this._dot(t.data,t.strides[0],t.offset)<=0&&this._add(t,e*s),this})),i(H.prototype,"_regularize",(function(t){var e=this._opts.lambda;return e<=0||this._scale(l(1-t*e,1e-7)),this})),i(H.prototype,"_scale",(function(t){var e;if(t<=0)throw new RangeError(r("0h1Pj",t));return(e=this._scaleFactor)<1e-11&&(h(this._N,e,this._weights,1),this._scaleFactor=1),this._scaleFactor*=t,this})),i(H.prototype,"_squaredHingeLoss",(function(t,e){var s,i;return s=this[this._learningRateMethod](),this._regularize(s),(i=e*this._dot(t.data,t.strides[0],t.offset))<1&&this._add(t,s*(e-i*e)),this})),n(H.prototype,"coefficients",(function(){var t=this._coefficients.data,e=this._weights;return d(e.length,e,1,t,1),h(this._N,this._scaleFactor,t,1),this._coefficients})),n(H.prototype,"nfeatures",(function(){return this._N})),i(H.prototype,"predict",(function(t,e){var s,i,r,n,a,o,d,h,l,p,m,_,b,y,w,R;for(i=t.data,n=t.shape,l=t.strides,m=t.offset,o=t.order,s=n.length-1,a=[],R=0;R<s;R++)a.push(n[R]);for(0===s?(_=1,r=new g(1),p=[0]):(_=v(a),r=new g(_),p=j(a,o)),y=new f("int8",r,a,p,0,o),b=this._N,h=l[s],R=0;R<_;R++)d=u(n,l,m,o,R*b,"throw"),w=this._dot(i,h,d),"label"===e?w=w>0?1:-1:"probability"===e&&(w=c(w)),0===s?y.iset(w):y.iset(R,w);return y})),i(H.prototype,"update",(function(t,e){return this._t+=1,this[this._lossMethod](t,e)}));var F={basic:["basic"],constant:["constant",.02],invscaling:["invscaling",.02,.5],pegasos:["pegasos"]},M=["basic","constant","invscaling","pegasos"],N=["hinge","log","modifiedHuber","perceptron","squaredHinge"];function z(t,e){var s;if(!x(e))return new TypeError(r("0h12V,FD",e));if(E(e,"intercept")&&(t.intercept=e.intercept,!w(t.intercept)))return new TypeError(r("0h12o,GE","intercept",t.intercept));if(E(e,"lambda")&&(t.lambda=e.lambda,!_(t.lambda)))return new TypeError(r("0h14k,I9","lambda",t.lambda));if(E(e,"learningRate")){if(!R(e.learningRate))return new TypeError(r("0h14l,Ig","learningRate",e.learningRate));if(s=e.learningRate[0],t.learningRate[0]=s,!L(M,s))return new TypeError(r("0h14m,Pg","learningRate",M.join('", "'),s));if(e.learningRate.length>1&&("constant"===s||"invscaling"===s)&&(t.learningRate[1]=e.learningRate[1],!b(t.learningRate[1])))return new TypeError(r("0h14n,Ph","learningRate",t.learningRate[1]));if(e.learningRate.length>2&&"invscaling"===s&&(t.learningRate[2]=e.learningRate[2],!y(t.learningRate[2])))return new TypeError(r("0h14o,Pi","learningRate",t.learningRate[2]))}return E(e,"loss")&&(t.loss=e.loss,!L(N,t.loss))?new TypeError(r("0h12X,3g,4S,GD,Gg,Jm","loss",N.join('", "'),t.loss)):null}function k(n,a){var o,d,h;if(!t(n))throw new TypeError(r("0h14b,Ht",n));if(d={intercept:!0,lambda:1e-4,learningRate:F.basic.slice(),loss:"log"},arguments.length>1&&(h=z(d,a)))throw h;return o=new H(n,d),i(l,"predict",p),l;function l(t,s){if(0===arguments.length)return o.coefficients;if(!e(t))throw new TypeError(r("0h14c,PZ",t));if(-1!==s&&1!==s)throw new TypeError(r("0h14d,Pa",s));if(t.shape[0]!==o.nfeatures)throw new TypeError(r("0h14e,Pb",o.nfeatures,t.shape[0]));return o.update(t,s),o.coefficients}function p(t,e){var i,a;if(!s(t))throw new TypeError(r("0h14f,Pc",t));if((i=t.shape)[i.length-1]!==n)throw new TypeError(r("0h1Pd",n,i[i.length-1]));if(a="label",arguments.length>1){if("probability"===e){if("log"!==d.loss&&"modifiedHuber"!==d.loss)throw new Error(r("0h14h,Pe",["log","modifiedHuber"].join('", "'),d.loss))}else if("label"!==e&&"linear"!==e)throw new TypeError(r("0h14i,Pf",e));a=e}return o.predict(t,a)}}export{k as default};
//# sourceMappingURL=index.mjs.map
