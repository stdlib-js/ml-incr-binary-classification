// Copyright (c) 2023 The Stdlib Authors. License is Apache-2.0: http://www.apache.org/licenses/LICENSE-2.0
/// <reference types="./index.d.ts" />
import{isPrimitive as t}from"https://cdn.jsdelivr.net/gh/stdlib-js/assert-is-positive-integer@esm/index.mjs";import e from"https://cdn.jsdelivr.net/gh/stdlib-js/assert-is-vector-like@esm/index.mjs";import s from"https://cdn.jsdelivr.net/gh/stdlib-js/assert-is-ndarray-like@esm/index.mjs";import i from"https://cdn.jsdelivr.net/gh/stdlib-js/utils-define-nonenumerable-read-only-property@esm/index.mjs";import r from"https://cdn.jsdelivr.net/gh/stdlib-js/error-tools-fmtprodmsg@v0.0.2-esm/index.mjs";import n from"https://cdn.jsdelivr.net/gh/stdlib-js/utils-define-nonenumerable-read-only-accessor@esm/index.mjs";import{ndarray as a}from"https://cdn.jsdelivr.net/gh/stdlib-js/blas-base-gdot@v0.0.8-esm/index.mjs";import{ndarray as o}from"https://cdn.jsdelivr.net/gh/stdlib-js/blas-base-gaxpy@v0.0.8-esm/index.mjs";import d from"https://cdn.jsdelivr.net/gh/stdlib-js/blas-base-dcopy@v0.0.10-esm/index.mjs";import l from"https://cdn.jsdelivr.net/gh/stdlib-js/blas-base-dscal@v0.0.10-esm/index.mjs";import h from"https://cdn.jsdelivr.net/gh/stdlib-js/math-base-special-max@esm/index.mjs";import p from"https://cdn.jsdelivr.net/gh/stdlib-js/math-base-special-exp@esm/index.mjs";import m from"https://cdn.jsdelivr.net/gh/stdlib-js/math-base-special-pow@v0.0.7-esm/index.mjs";import c from"https://cdn.jsdelivr.net/gh/stdlib-js/math-base-special-expit@esm/index.mjs";import g from"https://cdn.jsdelivr.net/gh/stdlib-js/array-float64@esm/index.mjs";import f from"https://cdn.jsdelivr.net/gh/stdlib-js/ndarray-ctor@esm/index.mjs";import u from"https://cdn.jsdelivr.net/gh/stdlib-js/ndarray-base-shape2strides@esm/index.mjs";import b from"https://cdn.jsdelivr.net/gh/stdlib-js/ndarray-base-numel@esm/index.mjs";import j from"https://cdn.jsdelivr.net/gh/stdlib-js/ndarray-base-vind2bind@esm/index.mjs";import{isPrimitive as _}from"https://cdn.jsdelivr.net/gh/stdlib-js/assert-is-nonnegative-number@esm/index.mjs";import{isPrimitive as v}from"https://cdn.jsdelivr.net/gh/stdlib-js/assert-is-positive-number@esm/index.mjs";import{isPrimitive as y}from"https://cdn.jsdelivr.net/gh/stdlib-js/assert-is-number@esm/index.mjs";import{isPrimitive as w}from"https://cdn.jsdelivr.net/gh/stdlib-js/assert-is-boolean@esm/index.mjs";import R from"https://cdn.jsdelivr.net/gh/stdlib-js/assert-is-array-like-object@esm/index.mjs";import x from"https://cdn.jsdelivr.net/gh/stdlib-js/assert-is-plain-object@esm/index.mjs";import L from"https://cdn.jsdelivr.net/gh/stdlib-js/assert-has-own-property@esm/index.mjs";import E from"https://cdn.jsdelivr.net/gh/stdlib-js/assert-contains@esm/index.mjs";var T={basic:"_basicLearningRate",constant:"_constantLearningRate",invscaling:"_inverseScalingLearningRate",pegasos:"_pegasosLearningRate"},H={hinge:"_hingeLoss",log:"_logLoss",modifiedHuber:"_modifiedHuberLoss",perceptron:"_perceptronLoss",squaredHinge:"_squaredHingeLoss"};function Q(t,e){var s;return this._N=t,this._opts=e,this._scaleFactor=1,this._t=0,this._learningRateMethod=T[e.learningRate[0]],this._lossMethod=H[e.loss],s=t,e.intercept&&(s+=1),this._weights=new g(s),this._coefficients=new f("float64",new g(s),[s],[1],0,"row-major"),this}i(Q.prototype,"_add",(function(t,e){var s=e/this._scaleFactor,i=this._weights;return o(t.shape[0],s,t.data,t.strides[0],t.offset,i,1,0),this._opts.intercept&&(i[this._N]+=s),this})),i(Q.prototype,"_basicLearningRate",(function(){return 10/(10+this._t)})),i(Q.prototype,"_constantLearningRate",(function(){return this._opts.learningRate[1]})),i(Q.prototype,"_dot",(function(t,e,s){var i=a(this._N,this._weights,1,0,t,e,s);return this._opts.intercept&&(i+=this._weights[this._N]),i*=this._scaleFactor})),i(Q.prototype,"_hingeLoss",(function(t,e){var s;return s=this[this._learningRateMethod](),this._regularize(s),e*this._dot(t.data,t.strides[0],t.offset)<1&&this._add(t,e*s),this})),i(Q.prototype,"_inverseScalingLearningRate",(function(){var t=this._opts.learningRate;return t[1]/m(this._t,t[2])})),i(Q.prototype,"_logLoss",(function(t,e){var s,i,r;return i=this[this._learningRateMethod](),this._regularize(i),r=this._dot(t.data,t.strides[0],t.offset),s=e/(1+p(e*r)),this._add(t,i*s),this})),i(Q.prototype,"_modifiedHuberLoss",(function(t,e){var s,i;return s=this[this._learningRateMethod](),this._regularize(s),(i=e*this._dot(t.data,t.strides[0],t.offset))<-1?this._add(t,4*s*e):this._add(t,s*(e-i*e)),this})),i(Q.prototype,"_pegasosLearningRate",(function(){return 1/(this._opts.lambda*this._t)})),i(Q.prototype,"_perceptronLoss",(function(t,e){var s;return s=this[this._learningRateMethod](),this._regularize(s),e*this._dot(t.data,t.strides[0],t.offset)<=0&&this._add(t,e*s),this})),i(Q.prototype,"_regularize",(function(t){var e=this._opts.lambda;return e<=0||this._scale(h(1-t*e,1e-7)),this})),i(Q.prototype,"_scale",(function(t){var e;if(t<=0)throw new RangeError(r("invalid argument. Attempting to scale a weight vector by a nonpositive value. This is likely due to too large a value of eta * lambda. Value: `%f`.",t));return(e=this._scaleFactor)<1e-11&&(l(this._N,e,this._weights,1),this._scaleFactor=1),this._scaleFactor*=t,this})),i(Q.prototype,"_squaredHingeLoss",(function(t,e){var s,i;return s=this[this._learningRateMethod](),this._regularize(s),(i=e*this._dot(t.data,t.strides[0],t.offset))<1&&this._add(t,s*(e-i*e)),this})),n(Q.prototype,"coefficients",(function(){var t=this._coefficients.data,e=this._weights;return d(e.length,e,1,t,1),l(this._N,this._scaleFactor,t,1),this._coefficients})),n(Q.prototype,"nfeatures",(function(){return this._N})),i(Q.prototype,"predict",(function(t,e){var s,i,r,n,a,o,d,l,h,p,m,_,v,y,w,R;for(i=t.data,n=t.shape,h=t.strides,m=t.offset,o=t.order,s=n.length-1,a=[],R=0;R<s;R++)a.push(n[R]);for(0===s?(_=1,r=new g(1),p=[0]):(_=b(a),r=new g(_),p=u(a,o)),y=new f("int8",r,a,p,0,o),v=this._N,l=h[s],R=0;R<_;R++)d=j(n,h,m,o,R*v,"throw"),w=this._dot(i,l,d),"label"===e?w=w>0?1:-1:"probability"===e&&(w=c(w)),0===s?y.iset(w):y.iset(R,w);return y})),i(Q.prototype,"update",(function(t,e){return this._t+=1,this[this._lossMethod](t,e)}));var z={basic:["basic"],constant:["constant",.02],invscaling:["invscaling",.02,.5],pegasos:["pegasos"]},F=["basic","constant","invscaling","pegasos"],M=["hinge","log","modifiedHuber","perceptron","squaredHinge"];function N(t,e){var s;if(!x(e))return new TypeError(r("0LQ2h",e));if(L(e,"intercept")&&(t.intercept=e.intercept,!w(t.intercept)))return new TypeError(r("0LQ30","intercept",t.intercept));if(L(e,"lambda")&&(t.lambda=e.lambda,!_(t.lambda)))return new TypeError(r("0LQ4x","lambda",t.lambda));if(L(e,"learningRate")){if(!R(e.learningRate))return new TypeError(r("0LQ4y","learningRate",e.learningRate));if(s=e.learningRate[0],t.learningRate[0]=s,!E(F,s))return new TypeError(r("0LQ4z","learningRate",F.join('", "'),s));if(e.learningRate.length>1&&("constant"===s||"invscaling"===s)&&(t.learningRate[1]=e.learningRate[1],!v(t.learningRate[1])))return new TypeError(r("invalid option. Second `%s` option must be a positive number. Option: `%s`.","learningRate",t.learningRate[1]));if(e.learningRate.length>2&&"invscaling"===s&&(t.learningRate[2]=e.learningRate[2],!y(t.learningRate[2])))return new TypeError(r("invalid option. Third `%s` option must be a number. Option: `%s`.","learningRate",t.learningRate[2]))}return L(e,"loss")&&(t.loss=e.loss,!E(M,t.loss))?new TypeError(r("0LQ3t","loss",M.join('", "'),t.loss)):null}function q(n,a){var o,d,l;if(!t(n))throw new TypeError(r("0LQ4o",n));if(d={intercept:!0,lambda:1e-4,learningRate:z.basic.slice(),loss:"log"},arguments.length>1&&(l=N(d,a)))throw l;return o=new Q(n,d),i(h,"predict",p),h;function h(t,s){if(0===arguments.length)return o.coefficients;if(!e(t))throw new TypeError(r("0LQ4p",t));if(-1!==s&&1!==s)throw new TypeError(r("0LQ4q",s));if(t.shape[0]!==o.nfeatures)throw new TypeError(r("invalid argument. First argument must be a one-dimensional ndarray of length %u. Actual length: `%u`.",o.nfeatures,t.shape[0]));return o.update(t,s),o.coefficients}function p(t,e){var i,a;if(!s(t))throw new TypeError(r("0LQ4s",t));if((i=t.shape)[i.length-1]!==n)throw new TypeError(r("invalid argument. First argument must be an ndarray whose last dimension is of size %u. Actual size: `%u`.",n,i[i.length-1]));if(a="label",arguments.length>1){if("probability"===e){if("log"!==d.loss&&"modifiedHuber"!==d.loss)throw new Error(r('invalid argument. Second argument is incompatible with model loss function. Probability predictions are only supported when the loss function is one of the following: "%s". Model loss function: `%s`.',["log","modifiedHuber"].join('", "'),d.loss))}else if("label"!==e&&"linear"!==e)throw new TypeError(r('invalid argument. Second argument must be a string value equal to either "label", "probability", or "linear". Value: `%s`.',e));a=e}return o.predict(t,a)}}export{q as default};
//# sourceMappingURL=index.mjs.map
